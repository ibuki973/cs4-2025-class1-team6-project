{% extends 'team6/base.html' %}
{% load static %}

{% block title %}ä¸‰ç›®ä¸¦ã¹ - ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾æˆ¦{% endblock %}

{% block content %}
<div class="container py-4">
    
    <div class="row justify-content-center mb-4">
        <div class="col-md-8">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="row text-center align-items-center">
                        <div class="col-5">
                            <h4 id="p1-name-display" class="fw-bold text-primary">Player 1</h4>
                            <div class="fs-2">
                                <span class="badge bg-light text-primary border" id="p1-mark">âœ–</span>
                            </div>
                            <div class="mt-2 fw-bold text-muted" id="p1-score">0 å‹</div>
                        </div>
                        
                        <div class="col-2">
                            <span class="fs-4 text-muted">VS</span>
                        </div>
                        
                        <div class="col-5">
                            <h4 id="p2-name-display" class="fw-bold text-danger">Player 2</h4>
                            <div class="fs-2">
                                <span class="badge bg-light text-danger border" id="p2-mark">ã€‡</span>
                            </div>
                            <div class="mt-2 fw-bold text-muted" id="p2-score">0 å‹</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="text-center mb-4">
        <div class="text-center mb-4">
    <div id="offline-timer" class="mb-3" style="display:none;">
        <span class="badge rounded-pill bg-dark p-2 px-4" style="border: 2px solid #ffc107;">
            <i class="fas fa-clock text-warning me-2"></i>
            <span id="time-left" style="font-size: 1.5rem; color: #ffc107;">20</span> ç§’
        </span>
    </div>
    <h3 id="status-msg" class="fw-bold text-dark">æº–å‚™ä¸­...</h3>
        <button id="next-btn" class="btn btn-warning px-4 fw-bold shadow-sm" style="display:none;" onclick="startNextGame()">
            æ¬¡ã®å¯¾æˆ¦ã¸ (å…ˆè¡Œäº¤ä»£) <i class="fas fa-arrow-right ms-2"></i>
        </button>
    </div>

    <div class="d-flex justify-content-center">
        <div id="offline-board">
            {% for i in "012345678" %}
            <div class="off-cell" data-index="{{ i }}" onclick="onCellClick(this)"></div>
            {% endfor %}
        </div>
    </div>

    <div class="text-center mt-5">
        <a href="{% url 'tictactoe' %}" class="text-muted text-decoration-none">
            <i class="fas fa-arrow-left me-1"></i> ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
        </a>
    </div>
</div>

<div class="modal fade" id="startModal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åå…¥åŠ›</h5>
            </div>
            <div class="modal-body p-4">
                <div class="mb-3">
                    <label class="form-label fw-bold">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1 (âœ–)</label>
                    <input type="text" id="input-p1" class="form-control form-control-lg" value="Aã•ã‚“">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2 (ã€‡)</label>
                    <input type="text" id="input-p2" class="form-control form-control-lg" value="Bã•ã‚“">
                </div>
                <p class="small text-muted mb-0">
                    â€» å…ˆè¡Œãƒ»å¾Œæ”»ã¯ãƒ©ãƒ³ãƒ€ãƒ ã«æ±ºå®šã•ã‚Œã¾ã™ã€‚<br>
                    â€» æ¬¡ã®è©¦åˆã§ã¯å…ˆè¡Œãƒ»å¾Œæ”»ãŒè‡ªå‹•ã§å…¥ã‚Œæ›¿ã‚ã‚Šã¾ã™ã€‚
                </div>
            <div class="modal-footer border-0">
                <button class="btn btn-primary btn-lg w-100 fw-bold" onclick="initGame()">å¯¾æˆ¦é–‹å§‹</button>
            </div>
        </div>
    </div>
</div>

<style>
    /* ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ç›¤é¢ã¨çµ±ä¸€ã—ãŸã‚¹ã‚¿ã‚¤ãƒ« */
    #offline-board {
        display: grid;
        grid-template-columns: repeat(3, 100px);
        grid-template-rows: repeat(3, 100px);
        gap: 8px;
        background-color: #333;
        padding: 8px;
        border-radius: 10px;
    }
    .off-cell {
        background-color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 3.5rem;
        font-weight: bold;
        cursor: pointer;
        user-select: none;
        transition: background-color 0.2s, color 0.2s;
    }
    .off-cell:hover { background-color: #f0f0f0; }
    .off-cell.taken { cursor: default; }
    
    /* å‹åˆ©ãƒ©ã‚¤ãƒ³ã®å¼·èª¿ */
    .off-cell.winning-cell {
        background-color: #28a745 !important;
        color: white !important;
    }

    /* ãƒãƒ¼ã‚¯ã®è‰²åˆ†ã‘ */
    .text-x { color: #0d6efd; }
    .text-o { color: #dc3545; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®å…¥åŠ›æ¬„ */
    .form-control:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
</style>

<script>
    // çŠ¶æ…‹ç®¡ç†
    let p1 = { name: "", mark: "âœ–", score: 0 };
    let p2 = { name: "", mark: "ã€‡", score: 0 };
    let board = Array(9).fill(null);
    let isGameActive = false;
    
    let firstMover = "";   // ãã®ã‚²ãƒ¼ãƒ ã®å…ˆè¡Œãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ('p1' or 'p2')
    let currentPlayer = ""; // ç¾åœ¨ã‚¿ãƒ¼ãƒ³ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ('p1' or 'p2') 
    let timerInterval = null; // â˜…ã“ã“ã‚’è¿½åŠ 

    // èµ·å‹•æ™‚ã«ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    document.addEventListener('DOMContentLoaded', () => {
        new bootstrap.Modal(document.getElementById('startModal')).show();
    });

function resetTimer() {
    clearInterval(timerInterval);
    if (!isGameActive) {
        document.getElementById('offline-timer').style.display = "none";
        return;
    } // â˜…ã“ã“ï¼ã“ã®ã€Œå‡ºå£ã€ã‚’ã“ã“ã«æ›¸ãã“ã¨ã§ã€ifæ–‡ãŒæ­£ã—ãçµ‚ã‚ã‚Šã¾ã™ã€‚

    let timeLeft = 20;
    const timerDisplay = document.getElementById('offline-timer');
    const timeText = document.getElementById('time-left');
    
    timerDisplay.style.display = "block";
    timeText.textContent = timeLeft;

    timerInterval = setInterval(() => {
        timeLeft--;
        timeText.textContent = timeLeft;
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            onTimeout();
        }
    }, 1000);
}


function onTimeout() {
    const winner = (currentPlayer === 'p1') ? p2 : p1;
    endGame(winner, null);
    alert("æ™‚é–“åˆ‡ã‚Œã§ã™ï¼");
}
    // 1. ã‚²ãƒ¼ãƒ åˆæœŸåŒ– (æœ€åˆã®1å›)
    function initGame() {
        p1.name = document.getElementById('input-p1').value || "Player 1";
        p2.name = document.getElementById('input-p2').value || "Player 2";
        
        bootstrap.Modal.getInstance(document.getElementById('startModal')).hide();

        // åˆå›ã®å…ˆè¡Œå¾Œæ”»ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«æ±ºå®š
        firstMover = (Math.random() < 0.5) ? 'p1' : 'p2';

        updateScoreBoard();
        startRound();
    }

    // 2. ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹
    function startRound() {
        board.fill(null);
        isGameActive = true;
        currentPlayer = firstMover; 

        document.querySelectorAll('.off-cell').forEach(c => {
            c.textContent = "";
            c.className = "off-cell";
        });
        document.getElementById('next-btn').style.display = "none";
        
        updateStatus();
        resetTimer();
    }

    // 3. æ¬¡ã®ã‚²ãƒ¼ãƒ  (å…ˆè¡Œå¾Œæ”»ã®ã¿äº¤ä»£)
    function startNextGame() {
        firstMover = (firstMover === 'p1') ? 'p2' : 'p1';
        startRound();
    }

    // ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
    function onCellClick(cell) {
        const idx = cell.dataset.index;
        if (!isGameActive || board[idx]) return;

        const playerObj = (currentPlayer === 'p1') ? p1 : p2;
        board[idx] = playerObj.mark;
        cell.textContent = playerObj.mark;
        cell.classList.add('taken');
        
        // è‰²åˆ†ã‘ã®é©ç”¨
        cell.classList.add(playerObj.mark === "âœ–" ? "text-x" : "text-o");

        const winLine = checkWin(playerObj.mark);
        if (winLine) {
            endGame(playerObj, winLine);
        } else if (board.every(v => v)) {
            endGame(null, null);
        } else {
            currentPlayer = (currentPlayer === 'p1') ? 'p2' : 'p1';
            updateStatus();
            resetTimer();
        }
    }

    // å‹æ•—åˆ¤å®š
    function checkWin(mark) {
        const wins = [
            [0,1,2],[3,4,5],[6,7,8],
            [0,3,6],[1,4,7],[2,5,8],
            [0,4,8],[2,4,6]
        ];
        for (let pattern of wins) {
            const [a, b, c] = pattern;
            if (board[a] === mark && board[b] === mark && board[c] === mark) {
                return pattern; // å‹åˆ©ãƒ©ã‚¤ãƒ³ã‚’è¿”ã™
            }
        }
        return null;
    }

    // çµ‚äº†å‡¦ç†
    function endGame(winner, winLine) {
        clearInterval(timerInterval);
        isGameActive = false;
        const msgElement = document.getElementById('status-msg');
        
        if (winner) {
            // å‹åˆ©ãƒ©ã‚¤ãƒ³ã‚’ç·‘è‰²ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            winLine.forEach(i => {
                document.querySelector(`[data-index="${i}"]`).classList.add('winning-cell');
            });
            
            const colorClass = winner.mark === "âœ–" ? "text-x" : "text-o";
            msgElement.innerHTML = `ğŸ† <span class="${colorClass}">${winner.name} (${winner.mark})</span> ã®å‹ã¡ï¼`;
            winner.score++;
        } else {
            msgElement.textContent = "å¼•ãåˆ†ã‘ï¼";
        }
        
        updateScoreBoard();
        document.getElementById('next-btn').style.display = "inline-block";
    }

    // è¡¨ç¤ºæ›´æ–°
    function updateScoreBoard() {
        document.getElementById('p1-name-display').textContent = p1.name;
        document.getElementById('p1-score').textContent = p1.score + " å‹";

        document.getElementById('p2-name-display').textContent = p2.name;
        document.getElementById('p2-score').textContent = p2.score + " å‹";
    }

    function updateStatus() {
        const p = (currentPlayer === 'p1') ? p1 : p2;
        const colorClass = p.mark === "âœ–" ? "text-x" : "text-o";
        document.getElementById('status-msg').innerHTML = `ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³: <span class="${colorClass}">${p.mark} (${p.name})</span>`;
    }
</script>
{% endblock %}