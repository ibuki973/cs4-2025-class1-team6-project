{% extends 'team6/base.html' %}
{% load static %}

{% block title %}ä¸‰ç›®ä¸¦ã¹ - ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾æˆ¦{% endblock %}

{% block content %}
<div class="container py-4">
    
    <div class="row justify-content-center mb-4">
        <div class="col-md-8">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="row text-center align-items-center">
                        <div class="col-5">
                            <h4 id="p1-name" class="fw-bold text-primary">Player 1</h4>
                            <div class="fs-2">
                                <span class="badge bg-light text-dark border" id="p1-mark">-</span>
                            </div>
                            <div class="mt-2 fw-bold" id="p1-score">0 å‹</div>
                        </div>
                        <div class="col-2">
                            <span class="fs-4 text-muted">VS</span>
                        </div>
                        <div class="col-5">
                            <h4 id="p2-name" class="fw-bold text-danger">Player 2</h4>
                            <div class="fs-2">
                                <span class="badge bg-light text-dark border" id="p2-mark">-</span>
                            </div>
                            <div class="mt-2 fw-bold" id="p2-score">0 å‹</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="text-center mb-4">
        <h3 id="status-msg" class="fw-bold">æº–å‚™ä¸­...</h3>
        <button id="next-btn" class="btn btn-warning px-4 fw-bold shadow-sm" style="display:none;" onclick="startNextGame()">
            æ¬¡ã®å¯¾æˆ¦ã¸ (å…ˆè¡Œäº¤ä»£) <i class="fas fa-arrow-right ms-2"></i>
        </button>
    </div>

    <div class="d-flex justify-content-center">
        <div id="offline-board">
            {% for i in "012345678" %}
            <div class="off-cell" data-index="{{ i }}" onclick="onCellClick(this)"></div>
            {% endfor %}
        </div>
    </div>

    <div class="text-center mt-5">
        <a href="{% url 'tictactoe' %}" class="text-muted text-decoration-none">
            <i class="fas fa-arrow-left me-1"></i> ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
        </a>
    </div>
</div>

<div class="modal fade" id="startModal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åå…¥åŠ›</h5>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1</label>
                    <input type="text" id="input-p1" class="form-control" value="Aã•ã‚“">
                </div>
                <div class="mb-3">
                    <label class="form-label">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2</label>
                    <input type="text" id="input-p2" class="form-control" value="Bã•ã‚“">
                </div>
                <p class="small text-muted">
                    â€»ãƒãƒ¼ã‚¯(â—‹/Ã—)ã¨å…ˆè¡Œãƒ»å¾Œæ”»ã¯ãƒ©ãƒ³ãƒ€ãƒ ã«æ±ºå®šã•ã‚Œã¾ã™ã€‚<br>
                    â€»æ¬¡æˆ¦ã‹ã‚‰ãƒãƒ¼ã‚¯ã¯ç¶­æŒã—ãŸã¾ã¾ã€å…ˆè¡Œãƒ»å¾Œæ”»ã®ã¿äº¤ä»£ã—ã¾ã™ã€‚
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary w-100" onclick="initGame()">å¯¾æˆ¦é–‹å§‹</button>
            </div>
        </div>
    </div>
</div>

<style>
    #offline-board {
        display: grid;
        grid-template-columns: repeat(3, 100px);
        grid-template-rows: repeat(3, 100px);
        gap: 8px;
        background-color: #333;
        padding: 8px;
        border-radius: 10px;
    }
    .off-cell {
        background-color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 3.5rem;
        font-weight: bold;
        cursor: pointer;
        user-select: none;
    }
    .off-cell:hover { background-color: #f0f0f0; }
    .off-cell.taken { cursor: default; }
    .off-cell.win { background-color: #d4edda; color: #198754; }
</style>

<script>
    // çŠ¶æ…‹ç®¡ç†
    let p1 = { name: "", mark: "", score: 0 };
    let p2 = { name: "", mark: "", score: 0 };
    let board = Array(9).fill(null);
    let isGameActive = false;
    
    let firstMover = "";   // ãã®ã‚²ãƒ¼ãƒ ã®å…ˆè¡Œãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ('p1' or 'p2')
    let currentPlayer = ""; // ç¾åœ¨ã‚¿ãƒ¼ãƒ³ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ('p1' or 'p2')

    // èµ·å‹•æ™‚ã«ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    document.addEventListener('DOMContentLoaded', () => {
        new bootstrap.Modal(document.getElementById('startModal')).show();
    });

    // 1. ã‚²ãƒ¼ãƒ åˆæœŸåŒ– (æœ€åˆã®1å›)
    function initGame() {
        p1.name = document.getElementById('input-p1').value || "Player 1";
        p2.name = document.getElementById('input-p2').value || "Player 2";
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
        bootstrap.Modal.getInstance(document.getElementById('startModal')).hide();

        // â˜…è¦ä»¶: â—‹Ã—ã‚’ä¹±æ•°ã§æ±ºå®š
        if (Math.random() < 0.5) {
            p1.mark = "â—‹"; p2.mark = "Ã—";
        } else {
            p1.mark = "Ã—"; p2.mark = "â—‹";
        }

        // â˜…è¦ä»¶: å…ˆè¡Œå¾Œæ”»ã‚’ä¹±æ•°ã§æ±ºå®š
        firstMover = (Math.random() < 0.5) ? 'p1' : 'p2';

        updateScoreBoard();
        startRound();
    }

    // 2. ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹
    function startRound() {
        board.fill(null);
        isGameActive = true;
        currentPlayer = firstMover; // å…ˆè¡Œãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰é–‹å§‹

        // ç›¤é¢ãƒªã‚»ãƒƒãƒˆ
        document.querySelectorAll('.off-cell').forEach(c => {
            c.textContent = "";
            c.className = "off-cell";
        });
        document.getElementById('next-btn').style.display = "none";
        
        updateStatus();
    }

    // 3. æ¬¡ã®ã‚²ãƒ¼ãƒ  (â˜…è¦ä»¶: å…ˆè¡Œå¾Œæ”»ã®ã¿äº¤ä»£ã€ãƒãƒ¼ã‚¯ã¯ç¶­æŒ)
    function startNextGame() {
        firstMover = (firstMover === 'p1') ? 'p2' : 'p1';
        startRound();
    }

    // ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
    function onCellClick(cell) {
        const idx = cell.dataset.index;
        if (!isGameActive || board[idx]) return;

        // ãƒãƒ¼ã‚¯æ›¸ãè¾¼ã¿
        const playerObj = (currentPlayer === 'p1') ? p1 : p2;
        board[idx] = playerObj.mark;
        cell.textContent = playerObj.mark;
        cell.classList.add('taken');
        
        // è‰²åˆ†ã‘ (â—‹ã¯é’ç³»ã€Ã—ã¯èµ¤ç³»ãªã©)
        cell.style.color = (playerObj.mark === "â—‹") ? "#0d6efd" : "#dc3545";

        if (checkWin(playerObj.mark)) {
            endGame(playerObj);
        } else if (board.every(v => v)) {
            endGame(null); // å¼•ãåˆ†ã‘
        } else {
            // äº¤ä»£
            currentPlayer = (currentPlayer === 'p1') ? 'p2' : 'p1';
            updateStatus();
        }
    }

    // å‹æ•—åˆ¤å®š
    function checkWin(mark) {
        const wins = [
            [0,1,2],[3,4,5],[6,7,8],
            [0,3,6],[1,4,7],[2,5,8],
            [0,4,8],[2,4,6]
        ];
        for (let pattern of wins) {
            const [a, b, c] = pattern;
            if (board[a] === mark && board[b] === mark && board[c] === mark) {
                // ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                pattern.forEach(i => document.querySelector(`[data-index="${i}"]`).classList.add('win'));
                return true;
            }
        }
        return false;
    }

    // çµ‚äº†å‡¦ç†
    function endGame(winner) {
        isGameActive = false;
        const msg = document.getElementById('status-msg');
        
        if (winner) {
            msg.innerHTML = `ğŸ† <b>${winner.name}</b> ã®å‹ã¡ï¼`;
            winner.score++; // â˜…è¦ä»¶: æˆ¦ç¸¾ã‚«ã‚¦ãƒ³ãƒˆ
        } else {
            msg.textContent = "å¼•ãåˆ†ã‘ï¼";
        }
        
        updateScoreBoard();
        document.getElementById('next-btn').style.display = "inline-block";
    }

    // è¡¨ç¤ºæ›´æ–°ç³»
    function updateScoreBoard() {
        document.getElementById('p1-name').textContent = p1.name;
        document.getElementById('p1-mark').textContent = p1.mark;
        document.getElementById('p1-score').textContent = p1.score + " å‹";

        document.getElementById('p2-name').textContent = p2.name;
        document.getElementById('p2-mark').textContent = p2.mark;
        document.getElementById('p2-score').textContent = p2.score + " å‹";
    }

    function updateStatus() {
        const p = (currentPlayer === 'p1') ? p1 : p2;
        document.getElementById('status-msg').textContent = `${p.name} (${p.mark}) ã®ã‚¿ãƒ¼ãƒ³`;
    }
</script>
{% endblock %}